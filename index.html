<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Carte France Mobile ‚Äì Trajets perso</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg: #0b1020;
            --card: #141b2f;
            --accent: #6ee7b7;
            --warn: #f87171;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: #fff;
            font-family: system-ui, Roboto
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        header {
            flex-shrink: 0;
            padding: 8px;
            background: #141b2f;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 6px
        }

        .title {
            font-size: 16px;
            font-weight: bold
        }

        .stats {
            font-size: 13px;
            color: #9ca3af
        }

        .panel {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            width: 100%
        }

        button,
        label {
            flex: 1 1 40%;
            min-width: 100px;
            background: #1f2937;
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: .2s;
        }

        button.primary {
            background: #065f46
        }

        button.warn {
            background: #7f1d1d
        }

        button:disabled {
            opacity: .5
        }

        #map {
            flex: 1;
            width: 100%;
        }

        .footer {
            padding: 6px;
            font-size: 12px;
            text-align: center;
            color: #9ca3af;
            background: #141b2f
        }

        input[type=file] {
            display: none
        }

        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #111827;
            color: #fff;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            opacity: 0;
            transition: .3s
        }

        #toast.show {
            opacity: 1
        }
    </style>
</head>

<body>
    <div id="app">
        <header>
            <div>
                <div class="title">üó∫Ô∏è Mes trajets</div>
                <div class="stats">Dist: <span id="dist">0.00</span> km | Points: <span id="pts">0</span></div>
            </div>
            <div class="panel">
                <button id="startBtn" class="primary">‚ñ∂Ô∏è Start</button>
                <button id="pauseBtn">‚è∏ Pause</button>
                <button id="resumeBtn" class="primary" disabled>‚èµ Reprendre</button>
                <button id="clearBtn" class="warn">üßπ Effacer</button>
                <button id="exportBtn">‚¨áÔ∏è Export</button>
                <label for="importFile">‚¨ÜÔ∏è Import</label>
                <input type="file" id="importFile" accept=".geojson,.json">
            </div>
        </header>
        <div id="map"></div>
        <div class="footer">‚ö° Les donn√©es restent sur ton t√©l√©phone (localStorage)</div>
    </div>
    <div id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        (function () {
            const STORAGE_KEY = "trajets_fr_mobile";
            let map, pathLine, coords = [], totalMeters = 0, watchId = null, paused = false;

            const distEl = document.getElementById("dist"), ptsEl = document.getElementById("pts");
            const startBtn = document.getElementById("startBtn"), pauseBtn = document.getElementById("pauseBtn"),
                resumeBtn = document.getElementById("resumeBtn"), clearBtn = document.getElementById("clearBtn"),
                exportBtn = document.getElementById("exportBtn"), importFile = document.getElementById("importFile");
            const toastEl = document.getElementById("toast");

            function toast(msg) { toastEl.textContent = msg; toastEl.classList.add("show"); setTimeout(() => toastEl.classList.remove("show"), 2500) }
            function fmtKm(m) { return (m / 1000).toFixed(2); }
            function haversine(a, b) {
                const R = 6371000, dLat = (b.lat - a.lat) * Math.PI / 180, dLng = (b.lng - a.lng) * Math.PI / 180;
                const s1 = Math.sin(dLat / 2), s2 = Math.sin(dLng / 2);
                return 2 * R * Math.asin(Math.sqrt(s1 * s1 + Math.cos(a.lat * Math.PI / 180) * Math.cos(b.lat * Math.PI / 180) * s2 * s2));
            }
            function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ coords, totalMeters })) }
            function load() { let raw = localStorage.getItem(STORAGE_KEY); if (raw) { let d = JSON.parse(raw); coords = d.coords || []; totalMeters = d.totalMeters || 0 } }
            function refresh() { if (pathLine) pathLine.remove(); if (coords.length) { pathLine = L.polyline(coords.map(c => [c.lat, c.lng]), { color: '#6ee7b7', weight: 4 }).addTo(map); map.fitBounds(pathLine.getBounds().pad(0.2)); } distEl.textContent = fmtKm(totalMeters); ptsEl.textContent = coords.length; }
            function onPos(pos) {
                const { latitude: lat, longitude: lng } = pos.coords; const c = { lat, lng, time: Date.now() };
                if (coords.length) { let d = haversine(coords[coords.length - 1], c); if (d < 5) return; totalMeters += d; }
                coords.push(c); save(); refresh();
            }
            function start() {
                if (!navigator.geolocation) { toast("Non support√©"); return; }
                if (watchId !== null) return; paused = false; watchId = navigator.geolocation.watchPosition(onPos, e => toast("Erreur"), { enableHighAccuracy: true }); startBtn.disabled = true; resumeBtn.disabled = true; pauseBtn.disabled = false; toast("Suivi d√©marr√©");
            }
            function pause() { if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; paused = true; resumeBtn.disabled = false; pauseBtn.disabled = true; toast("Pause"); } }
            function resume() { if (paused) { start(); toast("Reprise"); } }
            function clearAll() { pause(); coords = []; totalMeters = 0; save(); refresh(); toast("Effac√©"); }
            function exportGeo() { const blob = new Blob([JSON.stringify({ type: "FeatureCollection", features: [{ type: "Feature", geometry: { type: "LineString", coordinates: coords.map(c => [c.lng, c.lat]) }, properties: { distance: totalMeters } }] })], { type: "application/geo+json" }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = "trajet.geojson"; a.click(); URL.revokeObjectURL(url); }
            function importGeo(f) { const r = new FileReader(); r.onload = () => { try { const fc = JSON.parse(r.result); coords = []; totalMeters = 0; let prev = null; (fc.features[0].geometry.coordinates || []).forEach(([lng, lat]) => { let c = { lat, lng }; if (prev) totalMeters += haversine(prev, c); coords.push(c); prev = c; }); save(); refresh(); toast("Import ok"); } catch (e) { toast("Import invalide"); } }; r.readAsText(f); }
            // init
            map = L.map("map").setView([46.6, 2.2], 6);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "¬© OSM" }).addTo(map);
            load(); refresh();
            startBtn.onclick = start; pauseBtn.onclick = pause; resumeBtn.onclick = resume; clearBtn.onclick = clearAll; exportBtn.onclick = exportGeo;
            importFile.onchange = e => { if (e.target.files[0]) importGeo(e.target.files[0]); };
        })();
    </script>
</body>

</html>
